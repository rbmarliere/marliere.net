<!doctype html><html><head><title>Ricardo's Blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:type" content="website"><meta property="og:image" content="/img/profile.png"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://marliere.net/posts/4/"><meta property="og:title" content="Ricardo's Blog"><meta property="og:description" content="
    The use case is simple: boot a kernel from tftp, mount a root filesystem through NFS. From the minimal kernel built before, you need those symbols:
INET TCP/IP networking NFS_FS Network FS client support (v3) IP_PNP Automatic IP configuration IP_PNP_DHCP DHCP for IP auto config ROOT_NFS Root FS through NFS NETDEVICES Network device support USB_USBNET USB Networking USB_NET_SMSC95XX SMSC LAN95XX Ethernet adapter driver You could drop MMC, since you only need a single FAT32 partition containing the bootloader and firmware:
  
  "><meta name=twitter:card content="summary_large_image"><meta property="twitter:domain" content="https://marliere.net/"><meta property="twitter:url" content="https://marliere.net/posts/4/"><meta name=twitter:title content="Ricardo's Blog"><meta name=twitter:description content><meta name=twitter:image content="
    The use case is simple: boot a kernel from tftp, mount a root filesystem through NFS. From the minimal kernel built before, you need those symbols:
INET TCP/IP networking NFS_FS Network FS client support (v3) IP_PNP Automatic IP configuration IP_PNP_DHCP DHCP for IP auto config ROOT_NFS Root FS through NFS NETDEVICES Network device support USB_USBNET USB Networking USB_NET_SMSC95XX SMSC LAN95XX Ethernet adapter driver You could drop MMC, since you only need a single FAT32 partition containing the bootloader and firmware:
  
  "><link rel=alternate type=application/rss+xml href=/index.xml title="Ricardo's Blog"><link rel=stylesheet href=/scss/main.min.11ede061b646d76e0b8ea8368eb1f85373bda518701cdb52f47d7ba334bc0285.css integrity="sha256-Ee3gYbZG124Ljqg2jrH4U3O9pRhwHNtS9H17ozS8AoU=" crossorigin=anonymous></head><body><div class=wrapper><header><a href=https://marliere.net/>Posts</a>
<a href=/about/>About</a></header><main><div class=post-meta><div class=post-title>Booting the Raspberry Pi 3 from the network</div><div class=post-date>October 23, 2023</div></div><div class=post-content><p>The use case is simple: boot a kernel from <a href=https://tracker.debian.org/pkg/tftpd-hpa>tftp</a>, mount a root filesystem through
<a href=https://www.kernel.org/doc/Documentation/filesystems/nfs/nfsroot.txt>NFS</a>. From the minimal kernel built <a href=https://marliere.net/posts/3/>before</a>, you need those symbols:</p><dl><dt>INET</dt><dd>TCP/IP networking</dd><dt>NFS_FS</dt><dd>Network FS client support (v3)</dd><dt>IP_PNP</dt><dd>Automatic IP configuration</dd><dt>IP_PNP_DHCP</dt><dd>DHCP for IP auto config</dd><dt>ROOT_NFS</dt><dd>Root FS through NFS</dd><dt>NETDEVICES</dt><dd>Network device support</dd><dt>USB_USBNET</dt><dd>USB Networking</dd><dt>USB_NET_SMSC95XX</dt><dd>SMSC LAN95XX Ethernet adapter driver</dd></dl><p>You could drop MMC, since you only need a single FAT32 partition containing the
<a href=https://u-boot.readthedocs.io/en/latest/usage/index.html#shell-commands>bootloader</a> and firmware:</p><ul><li>start.elf</li><li>bootcode.bin</li><li>fixup.dat</li><li>config.txt</li><li>u-boot.bin</li><li>boot.scr</li></ul><p>The first three are the same firmware files from before and <strong>config.txt</strong> will have the
following content:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>arm_64bit=1
</span></span><span style=display:flex><span>kernel=u-boot.bin
</span></span></code></pre></div><p>After <a href=https://source.denx.de/u-boot/u-boot>building</a> <strong>u-boot.bin</strong>, go ahead and create a <strong>boot.cmd</strong> script
file like so:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>setenv serverip 192.168.1.100
</span></span><span style=display:flex><span>setenv ipaddr 192.168.1.101
</span></span><span style=display:flex><span>setenv bootargs root=/dev/nfs rw nfsroot=192.168.1.100:/exports/aarch64,nfsvers=3 ip=dhcp
</span></span><span style=display:flex><span>tftpboot ${fdt_addr_r} dtb
</span></span><span style=display:flex><span>tftpboot ${kernel_addr_r} kernel
</span></span><span style=display:flex><span>booti ${kernel_addr_r} - ${fdt_addr_r}
</span></span></code></pre></div><p>Build it with:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$GIT_DIR/u-boot/tools/mkimage -A arm64 -O linux -T script -C none -d boot.cmd boot.scr
</span></span></code></pre></div><p>This script assumes that your host 192.168.1.100 serves both <a href=https://tracker.debian.org/pkg/tftpd-hpa>tftp</a> and
<a href=https://tracker.debian.org/pkg/nfs-utils>nfs-kernel-server</a>. You need something like this in your <strong>/etc/exports</strong> file:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/exports/aarch64 *<span style=color:#af3a03>(</span>rw,sync,no_root_squash,no_subtree_check<span style=color:#af3a03>)</span>
</span></span></code></pre></div><p>It also expects both <strong>dtb</strong> and <strong>kernel</strong> files to be present in the tftp share root.
Instead of pin-pointing to version names, you can use symbolic links, e.g.:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#b57614>cd</span> /srv/tftp
</span></span><span style=display:flex><span>ln -s vmlinuz-6.6.0-rc1+ kernel
</span></span><span style=display:flex><span>ln -s broadcom/bcm2837-rpi-3-b.dtb dtb
</span></span></code></pre></div><p>The links can&rsquo;t point to outside the share root, though.</p><figure><img src=/img/rpi_nfs.png><figcaption><h4>Profit.</h4></figcaption></figure><p> </p><hr><h2 id=references>References</h2><ul><li><a href=https://elinux.org/RPi_U-Boot>Embedded Linux Wiki</a></li><li><a href=https://sergioprado.org/utilizando-o-u-boot-na-raspberry-pi/>Sérgio Prado</a></li><li><a href=https://github.com/mhomran/u-boot-rpi3-b-plus>Mohammed Hassanin</a></li></ul></div></main><footer>&copy; <a href=https://github.com/rbmarliere/marliere.net>Copyleft</a>
2024 Ricardo B. Marliere
<a href=/index.xml title="Ricardo's Blog"><i class="fa-solid fa-rss"></i></a></footer></div></body></html>