<!doctype html><html><head><title>Ricardo's Blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:type" content="website"><meta property="og:image" content="/img/profile.png"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://marliere.net/posts/2/"><meta property="og:title" content="Ricardo's Blog"><meta property="og:description" content="
    If you followed along my last post, you may have found some difficulties like I did. Namely, making sure the work is done without confusion. In this post I want to share a few tips that helped me stay organized and effective, I hope its helpful to some of you as well.
When I started investigating bugs I used to have a single git tree and then every time I wanted to switch bugs or build a stable kernel it was .
  
  "><meta name=twitter:card content="summary_large_image"><meta property="twitter:domain" content="https://marliere.net/"><meta property="twitter:url" content="https://marliere.net/posts/2/"><meta name=twitter:title content="Ricardo's Blog"><meta name=twitter:description content><meta name=twitter:image content="
    If you followed along my last post, you may have found some difficulties like I did. Namely, making sure the work is done without confusion. In this post I want to share a few tips that helped me stay organized and effective, I hope its helpful to some of you as well.
When I started investigating bugs I used to have a single git tree and then every time I wanted to switch bugs or build a stable kernel it was .
  
  "><link rel=alternate type=application/rss+xml href=/index.xml title="Ricardo's Blog"><link rel=stylesheet href=/scss/main.min.11ede061b646d76e0b8ea8368eb1f85373bda518701cdb52f47d7ba334bc0285.css integrity="sha256-Ee3gYbZG124Ljqg2jrH4U3O9pRhwHNtS9H17ozS8AoU=" crossorigin=anonymous></head><body><div class=wrapper><header><a href=https://marliere.net/>Posts</a>
<a href=/about/>About</a></header><main><div class=post-meta><div class=post-title>A better workflow for kernel debugging</div><div class=post-date>October 8, 2023</div></div><div class=post-content><p>If you followed along my last <a href=https://marliere.net/posts/1/>post</a>, you may have found some
difficulties like I did. Namely, making sure the work is done without confusion. In this
post I want to share a few tips that helped me stay organized and effective, I hope its
helpful to some of you as well.</p><p>When I started investigating bugs I used to have a single <strong>git</strong> tree and then every
time I wanted to switch bugs or build a stable kernel it was <strong>.config</strong> hell, a
complete mess. I tried, then, maintaining different local repositories for different
trees. But this is a disk waste. Then I learned about the &ldquo;<strong>make O=</strong>&rdquo; trick to build
the objects somewhere else. It helped but I still had to checkout different commits and
keep a tab of what I was doing in my head. The solution was of course to use
<a href=https://git-scm.com/docs/git-worktree>git-worktree</a>. This is the process (all the variables in this post are
illustrative):</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#928374;font-style:italic># create your local work directory</span>
</span></span><span style=display:flex><span>LINUX_DIR<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;</span>$HOME<span style=color:#79740e>/linux&#34;</span>
</span></span><span style=display:flex><span>mkdir $LINUX_DIR
</span></span><span style=display:flex><span><span style=color:#b57614>cd</span> $LINUX_DIR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># clone a bare repository</span>
</span></span><span style=display:flex><span>git clone --bare -o linus git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
</span></span><span style=display:flex><span><span style=color:#b57614>cd</span> linux.git
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># add other relevant remotes to you</span>
</span></span><span style=display:flex><span>git remote add shuah git://git.kernel.org/pub/scm/linux/kernel/git/shuah/linux-kselftest.git
</span></span><span style=display:flex><span>git remote add staging git://git.kernel.org/pub/scm/linux/kernel/git/gregkh/staging.git
</span></span><span style=display:flex><span>git remote add stable git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># (...)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># update all the remotes</span>
</span></span><span style=display:flex><span>git remote update
</span></span></code></pre></div><p>Now that you have a bare repository, you can add worktrees to split the different things
you might be doing into different directories. Here&rsquo;s an example:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#b57614>cd</span> $LINUX_DIR/linux.git
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># add a worktree to track the stable/linux-6.5.y branch</span>
</span></span><span style=display:flex><span>git worktree add --track --branch linux-6.5.y ../stable stable/linux-6.5.y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># add a worktree for a syzkaller bug</span>
</span></span><span style=display:flex><span>git worktree add --checkout ../845cd8e5c47f2a125683 69b41ac87e4a
</span></span></code></pre></div><p>This way, you can have different directories with different kernel <strong>.config</strong> files and
different <strong>git</strong> histories and patches you might be working on. In the example above,
<a href="https://syzkaller.appspot.com/bug?extid=845cd8e5c47f2a125683">845cd8e5c47f2a125683</a> is a random bug I selected and
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=69b41ac87e4a664de78a395ff97166f0b2943210">69b41ac87e4a</a> is the commit ref. from the <strong>2023/01/04 06:51</strong> row of its
crashes. You would proceed by downloading its <strong>.config</strong> and other relevant files such
as the reproducers. For that it&rsquo;s best to have a directory only for these:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>BUGS_DIR<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;</span>$HOME<span style=color:#79740e>/syzkaller-bugs&#34;</span>
</span></span><span style=display:flex><span>mkdir -p $BUGS_DIR/845cd8e5c47f2a125683
</span></span><span style=display:flex><span><span style=color:#b57614>cd</span> $BUGS_DIR/845cd8e5c47f2a125683
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># download relevant files for the bug</span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># (you might wanna split those into timestamped directories,</span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic>#   e.g. $BUGS_DIR/845cd8e5c47f2a125683/202301040651 )</span>
</span></span><span style=display:flex><span>wget <span style=color:#79740e>&#34;https://syzkaller.appspot.com/text?tag=KernelConfig&amp;x=9babfdc3dd4772d0&#34;</span> -O .config
</span></span><span style=display:flex><span>wget <span style=color:#79740e>&#34;https://syzkaller.appspot.com/text?tag=ReproC&amp;x=142a1eaa480000&#34;</span> -O rep.c
</span></span><span style=display:flex><span>wget <span style=color:#79740e>&#34;https://storage.googleapis.com/syzbot-assets/d4a7091814ba/bzImage-69b41ac8.xz&#34;</span>
</span></span><span style=display:flex><span>unxz bzImage-69b41ac8.xz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># make your life easier with a link to the worktree</span>
</span></span><span style=display:flex><span>ln -s $LINUX_DIR/845cd8e5c47f2a125683 linux
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cp .config linux/
</span></span></code></pre></div><p>After the usual building process of the bzImage, its time to jump into a virtual machine
to test your changes. This can also be chaotic and inspired by this great <a href=https://www.linuxfoundation.org/webinars/linux-kernel-debugging-tricks-of-the-trade>mentorship
session</a> done by Joel Fernandes, I wrote some <a href=https://github.com/rbmarliere/rq>scripts</a> to make my life
easier. The main tool is <strong>rq</strong>:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ rq -h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>usage: rq [-h] [-I IMG_DIR] [-k KERNEL] [--no-kernel] [-d DISK] [--no-disk]
</span></span><span style=display:flex><span>          [-i INITRD] [-b BIOS] [-p PORT] [-f [F ...]] [-F [F ...]] [-c]
</span></span><span style=display:flex><span>          [-a APPEND] [-g] [--wait-gdb] [--no-snapshot] [--debug]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Run qemu with sane defaults
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>options:
</span></span><span style=display:flex><span>  -h, --help            show this help message and exit
</span></span><span style=display:flex><span>  -I IMG_DIR, --img-dir IMG_DIR
</span></span><span style=display:flex><span>                        directory containing images (e.g. initramfs, disk,
</span></span><span style=display:flex><span>                        bios), can be set through RQ_IMGDIR environment variable
</span></span><span style=display:flex><span>                        (default: /home/rbmarliere/images)
</span></span><span style=display:flex><span>  -k KERNEL, --kernel KERNEL
</span></span><span style=display:flex><span>                        kernel bootable image to use with -kernel (default:
</span></span><span style=display:flex><span>                        linux/arch/x86/boot/bzImage)
</span></span><span style=display:flex><span>  --no-kernel           do not use -kernel (default: False)
</span></span><span style=display:flex><span>  -d DISK, --disk DISK  disk image to use with -drive (default:
</span></span><span style=display:flex><span>                        /home/rbmarliere/images/disk.img)
</span></span><span style=display:flex><span>  --no-disk             do not use -drive (default: False)
</span></span><span style=display:flex><span>  -i INITRD, --initrd INITRD
</span></span><span style=display:flex><span>                        initrd image to use with -initrd (default: None)
</span></span><span style=display:flex><span>  -b BIOS, --bios BIOS  bios image to use with -bios (default:
</span></span><span style=display:flex><span>                        /home/rbmarliere/images/seabios.bin)
</span></span><span style=display:flex><span>  -p PORT, --port PORT  host&#39;s port to forward into guest&#39;s ssh port using -net
</span></span><span style=display:flex><span>                        (default: 10022)
</span></span><span style=display:flex><span>  -f [F ...]            file(s) to copy into the disk (default: None)
</span></span><span style=display:flex><span>  -F [F ...]            file(s) to copy into the cpio initrd (default: None)
</span></span><span style=display:flex><span>  -c, --crash           append crashkernel= to cmdline (default: False)
</span></span><span style=display:flex><span>  -a APPEND, --append APPEND
</span></span><span style=display:flex><span>                        append kernel parameters (default: None)
</span></span><span style=display:flex><span>  -g, --gdb             use -s (default: False)
</span></span><span style=display:flex><span>  --wait-gdb            use -S if -s is used (default: False)
</span></span><span style=display:flex><span>  --no-snapshot         do not use -snapshot (default: False)
</span></span><span style=display:flex><span>  --debug               print qemu command instead of running it (default:
</span></span><span style=display:flex><span>                        False)
</span></span></code></pre></div><p>This makes me able to do many things without having to worry about searching back my
shell history for the right <strong>qemu</strong> command. It&rsquo;s not perfect, but it helps. If you
noticed, the <strong>&ndash;bios</strong> parameter defaults to <strong>/home/rbmarliere/images/seabios.bin</strong>,
this is because I&rsquo;m using a custom built image with a <a href=https://github.com/cirosantilli/linux-kernel-module-cheat/issues/110#issuecomment-1498600775>patch</a> to
<a href=https://gitlab.com/qemu-project/seabios>SeaBIOS</a> that gets rid of the code that truncates long lines in the terminal,
so that I don&rsquo;t lose precious info from logs. This is what it calls on a default run
without parameters, inside a directory such as <strong>$BUGS_DIR/845cd8e5c47f2a125683</strong>:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ rq --debug
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>qemu-system-x86_64 \
</span></span><span style=display:flex><span>    -m 8G \
</span></span><span style=display:flex><span>    -smp 2,sockets=2,cores=1 \
</span></span><span style=display:flex><span>    -net nic,model=e1000 \
</span></span><span style=display:flex><span>    -net user,host=10.0.2.25,hostfwd=tcp::10022-:22 \
</span></span><span style=display:flex><span>    -enable-kvm \
</span></span><span style=display:flex><span>    -nographic \
</span></span><span style=display:flex><span>    -bios /home/rbmarliere/images/seabios.bin \
</span></span><span style=display:flex><span>    -snapshot \
</span></span><span style=display:flex><span>    -kernel linux/arch/x86/boot/bzImage \
</span></span><span style=display:flex><span>    -drive format=raw,file=/home/rbmarliere/images/disk.img
</span></span></code></pre></div><p>If you&rsquo;re feeling courageous and want to give it a try, install them with something like
this:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>GIT_DIR<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;</span>$HOME<span style=color:#79740e>/git&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git clone git@github.com:rbmarliere/rq.git $GIT_DIR/rq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b57614>cd</span> $HOME/.local/bin
</span></span><span style=display:flex><span><span style=color:#af3a03>for</span> file in $GIT_DIR/rq/*; <span style=color:#af3a03>do</span> ln -s $file; <span style=color:#af3a03>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># add ~/.local/bin to your $PATH, if you don&#39;t have it</span>
</span></span><span style=display:flex><span><span style=color:#b57614>echo</span> <span style=color:#b57614>export</span> PATH<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;</span>$PATH<span style=color:#79740e>:</span>$HOME<span style=color:#79740e>/.local/bin&#34;</span> &gt;&gt; ~/.bashrc
</span></span></code></pre></div><p>Some examples:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#b57614>export</span> RQ_IMGDIR<span style=color:#af3a03>=</span>~/images
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># run a specific kernel after copying a reproducer into the disk</span>
</span></span><span style=display:flex><span>rq -k bzImage-69b41ac8 -f rep.c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># use an initramfs instead of a disk as the root filesystem</span>
</span></span><span style=display:flex><span>rq -i initramfs.cpio.gz -F rep.c --no-disk -a <span style=color:#79740e>&#34;root=/dev/ram&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># make permanent changes to the disk root filesystem</span>
</span></span><span style=display:flex><span>rq --no-snapshot
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># debug the VM with gdb</span>
</span></span><span style=display:flex><span>rq -g --wait-gdb
</span></span></code></pre></div><h2 id=kdump>Kdump</h2><p>Recently I was looking into a bug that is a concurrency problem. That means that,
although the reproducer provided can in fact reproduce the problem, it happens at random
times. That means you are probably gonna have to wait for a long time. So as much as the
<strong>gdb</strong> workflow presented in the <a href=https://marliere.net/posts/1/>last post</a> is very useful, for bugs
like this it can be quite painful. Using <a href=https://www.kernel.org/doc/html/latest/admin-guide/kdump/kdump.html>Kdump</a> and the <a href=https://github.com/crash-utility/crash>crash
utility</a> enabled me to inspect the system state at any time without having to
depend on a running virtual machine.</p><p>I went through this <a href="https://www.youtube.com/watch?v=aUGNDJPpUUg">excellent presentation</a> by Steven Rostedt and I must
say, it took me a while to grasp the process and setup everything. But its a very good
tool to have, sometimes. Hopefully I can help you save some time. The first thing you
need is to build a &ldquo;crash&rdquo; kernel. This is the kernel that it&rsquo;s going to replace the
system kernel after a panic. Here is what I did:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#b57614>cd</span> $LINUX_DIR/linux.git
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git worktree add --checkout ../crash v6.5.6
</span></span><span style=display:flex><span><span style=color:#b57614>cd</span> ../crash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>make allnoconfig
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># from `make help`:</span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># allnoconfig     - New config where all options are answered with no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>make menuconfig
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># TIP: when you search for a string using &#39;/&#39; character, the list provided</span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># have numbers attached to them, which you can use to quickly jump to its</span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># entry in the menu; you can also use &#39;?&#39; character for help.</span>
</span></span></code></pre></div><p>Search and enable the following:</p><dl><dt>64BIT</dt><dd>64-bit kernel</dd><dt>PCI</dt><dd>support for PCI bus</dd><dt>ATA</dt><dd>support for ATA hard disk used in -disk parameter</dd><dt>ATA_PIIX</dt><dd>ATA controller emulated by the default qemu x86_64 machine</dd><dt>SERIAL_8250</dt><dd>support for serial ports</dd><dt>SERIAL_8250_CONSOLE</dt><dd>this enables the virtual machine console to be readable</dd><dt>EXT4_FS</dt><dd>the filesystem used before, when creating the root fs</dd><dt>BLK_DEV_SD</dt><dd>this makes /dev/sda visible</dd><dt>NET</dt><dd>we want networking inside the VM</dd><dt>NETDEVICES</dt><dd>add support for networking devices</dd><dt>E1000</dt><dd>driver for the -net nic,model=e1000 parameter</dd><dt>INET</dt><dd>TCP/IP support</dd><dt>UNIX</dt><dd>Unix sockets support, e.g. for /var/log/* and system utils</dd><dt>PACKET</dt><dd>Packet protocol</dd><dt>BINFMT_ELF</dt><dd>enables kernel to execute ELF files</dd><dt>BINFMT_SCRIPT</dt><dd>enables kernel to execute &lsquo;#!&rsquo; scripts</dd><dt>DEVTMPFS</dt><dd>create a /dev early on, to support early API filesystems</dd><dt>DEVTMPFS_MOUNT</dt><dd>auto mount /dev</dd><dt>TMPFS</dt><dd>support early API filesystems</dd><dt>CRASH_DUMP</dt><dd>Kdump requirement</dd><dt>RELOCATABLE</dt><dd>Kdump requirement</dd><dt>CGROUPS</dt><dd>* (systemd requirement)</dd><dt>INOTIFY_USER</dt><dd>* (systemd requirement)</dd><dt>DEBUG_FS</dt><dd>*</dd><dt>SECURITYFS</dt><dd>*</dd><dt>CONFIGFS_FS</dt><dd>*</dd><dt>BINFMT_MISC</dt><dd>*</dd><dt>AUTOFS_FS</dt><dd>* (for proc-sys-fs-binfmt_misc.automount service)</dd></dl><p>Then, build the compressed kernel image:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make bzImage
</span></span></code></pre></div><p>This was the first time I configured a minimal kernel from zero and I learned a lot from
it. These are the symbols that need to be enabled to successfully boot the kernel after
a crash. Note that the ones marked with <strong>*</strong> are dependencies for the root filesystem.
Systemd needs CGROUPS and INOTIFY_USER and the others come from the <strong>/etc/fstab</strong>
written by the syzkaller&rsquo;s <a href=https://github.com/google/syzkaller/blob/master/tools/create-image.sh#L161>create-image.sh</a> script that I used to
create my root filesystem (therefore, optional).</p><p>After this, you should install <strong>kdump-tools</strong> inside your VM:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#928374;font-style:italic># you can use any kernel to boot the VM, e.g.</span>
</span></span><span style=display:flex><span><span style=color:#b57614>cd</span> $BUGS_DIR/845cd8e5c47f2a125683
</span></span><span style=display:flex><span>rq --no-snapshot -k bzImage-69b41ac8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># after booting, inside the VM</span>
</span></span><span style=display:flex><span>apt install kdump-tools
</span></span><span style=display:flex><span>vi /etc/default/kdump-tools
</span></span></code></pre></div><p>Edit the <strong>/etc/default/kdump-tools</strong> file, inside the VM, accordingly (remember to use
<strong>--no-snapshot</strong> to make it permanent). Please refer to Debian&rsquo;s documentation on
kdump-tools in <a href=https://salsa.debian.org/debian/kdump-tools/-/blob/master/debian/kdump-tools.README.Debian>/usr/share/doc/kdump-tools/README.Debian</a>. Here is mine:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>USE_KDUMP<span style=color:#af3a03>=</span><span style=color:#8f3f71>1</span>
</span></span><span style=display:flex><span>KDUMP_COREDIR<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;/var/crash&#34;</span>
</span></span><span style=display:flex><span>SSH<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;rbmarliere@10.0.2.25&#34;</span>
</span></span><span style=display:flex><span>SSH_KEY<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;/root/.ssh/id_rsa&#34;</span>
</span></span></code></pre></div><p>This way, whenever a crash happens, the <strong>kdump-tools</strong> will transfer the dump file into
my host&rsquo;s <strong>/var/crash/</strong> directory. Before, I did the usual <strong>ssh</strong> authorization
process of creating a <strong>ssh</strong> key with <a href=https://man.openbsd.org/ssh-keygen.1><strong>ssh-keygen</strong></a> in the host,
transferring the private id_rsa into the VM and pasting the public key into the host&rsquo;s
<strong>~/.ssh/authorized_keys</strong>. Also, make sure <strong>/var/crash</strong> is owned and writable by your
user in the host, or change <strong>KDUMP_COREDIR</strong> to something else.</p><p>Now we are only missing three things:</p><ul><li>Boot the system kernel with <strong>crashkernel=</strong> cmdline;</li><li>Load the crash kernel into memory using <strong>kexec</strong>;</li><li>Trigger the crash;</li></ul><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#928374;font-style:italic># make your life easier with a link to the crashkernel</span>
</span></span><span style=display:flex><span><span style=color:#b57614>cd</span> $BUGS_DIR/
</span></span><span style=display:flex><span>ln -s $LINUX_DIR/crash/arch/x86_64/boot/bzImage crashkernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># copy the crashkernel into the root filesystem next time you boot a VM</span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># -f copies the file into /root/ by default</span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># -c will append crashkernel=256M to the boot cmdline</span>
</span></span><span style=display:flex><span><span style=color:#b57614>cd</span> $BUGS_DIR/845cd8e5c47f2a125683
</span></span><span style=display:flex><span>rq -c -f ../crashkernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># after boot, inside the VM</span>
</span></span><span style=display:flex><span>kexec -p /root/crashkernel --append<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;console=ttyS0 root=/dev/sda&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># trigger the crash with CONFIG_MAGIC_SYSRQ=y</span>
</span></span><span style=display:flex><span><span style=color:#b57614>echo</span> c &gt; /proc/sysrq-trigger
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># ...or run a syz reproducer</span>
</span></span><span style=display:flex><span>gcc rep.c <span style=color:#af3a03>&amp;&amp;</span> ./a.out
</span></span></code></pre></div><p>Note the need for <strong>root=/dev/sda</strong> for the automatic handling of the crash dump taking
place. If all went well, you&rsquo;re gonna see the dump and the dmesg files under your host
<strong>/var/crash</strong> directory. But how to use it? Here enters the <a href=https://github.com/crash-utility/crash>crash utility</a>. For
some reason that I didn&rsquo;t fully understand &ndash; probably Debian related<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> &ndash; I was only
able to inspect the dump file using a locally built binary. Therefore, don&rsquo;t install the
<a href=https://tracker.debian.org/pkg/crash>crash</a> package in your host.</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$GIT_DIR/crash/crash $LINUX_DIR/845cd8e5c47f2a125683/vmlinux dump.202310081631
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>crash 8.0.3
</span></span><span style=display:flex><span>Copyright (C) 2002-2022  Red Hat, Inc.
</span></span><span style=display:flex><span>Copyright (C) 2004, 2005, 2006, 2010  IBM Corporation
</span></span><span style=display:flex><span>Copyright (C) 1999-2006  Hewlett-Packard Co
</span></span><span style=display:flex><span>Copyright (C) 2005, 2006, 2011, 2012  Fujitsu Limited
</span></span><span style=display:flex><span>Copyright (C) 2006, 2007  VA Linux Systems Japan K.K.
</span></span><span style=display:flex><span>Copyright (C) 2005, 2011, 2020-2022  NEC Corporation
</span></span><span style=display:flex><span>Copyright (C) 1999, 2002, 2007  Silicon Graphics, Inc.
</span></span><span style=display:flex><span>Copyright (C) 1999, 2000, 2001, 2002  Mission Critical Linux, Inc.
</span></span><span style=display:flex><span>Copyright (C) 2015, 2021  VMware, Inc.
</span></span><span style=display:flex><span>This program is free software, covered by the GNU General Public License,
</span></span><span style=display:flex><span>and you are welcome to change it and/or distribute copies of it under
</span></span><span style=display:flex><span>certain conditions.  Enter &#34;help copying&#34; to see the conditions.
</span></span><span style=display:flex><span>This program has absolutely no warranty.  Enter &#34;help warranty&#34; for details.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>GNU gdb (GDB) 10.2
</span></span><span style=display:flex><span>Copyright (C) 2021 Free Software Foundation, Inc.
</span></span><span style=display:flex><span>License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
</span></span><span style=display:flex><span>This is free software: you are free to change and redistribute it.
</span></span><span style=display:flex><span>There is NO WARRANTY, to the extent permitted by law.
</span></span><span style=display:flex><span>Type &#34;show copying&#34; and &#34;show warranty&#34; for details.
</span></span><span style=display:flex><span>This GDB was configured as &#34;x86_64-pc-linux-gnu&#34;.
</span></span><span style=display:flex><span>Type &#34;show configuration&#34; for configuration details.
</span></span><span style=display:flex><span>Find the GDB manual and other documentation resources online at:
</span></span><span style=display:flex><span>    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>For help, type &#34;help&#34;.
</span></span><span style=display:flex><span>Type &#34;apropos word&#34; to search for commands related to &#34;word&#34;...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>please wait... (determining panic task)
</span></span><span style=display:flex><span>WARNING: active task ffff888102323780 on cpu 1 not found in PID hash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      KERNEL: /mnt/md0/linux/845cd8e5c47f2a125683/vmlinux
</span></span><span style=display:flex><span>    DUMPFILE: dump.202310081631  [PARTIAL DUMP]
</span></span><span style=display:flex><span>        CPUS: 2
</span></span><span style=display:flex><span>        DATE: Sun Oct  8 13:31:48 -03 2023
</span></span><span style=display:flex><span>      UPTIME: 00:01:22
</span></span><span style=display:flex><span>LOAD AVERAGE: 0.95, 0.47, 0.17
</span></span><span style=display:flex><span>       TASKS: 3
</span></span><span style=display:flex><span>    NODENAME: syzkaller
</span></span><span style=display:flex><span>     RELEASE: v6.2-rc3~30
</span></span><span style=display:flex><span>     VERSION: #7 SMP PREEMPT_DYNAMIC Sun Oct  8 10:34:01 -03 2023
</span></span><span style=display:flex><span>     MACHINE: x86_64  (3892 Mhz)
</span></span><span style=display:flex><span>      MEMORY: 8 GB
</span></span><span style=display:flex><span>       PANIC: &#34;Kernel panic - not syncing: sysrq triggered crash&#34;
</span></span><span style=display:flex><span>         PID: 4194
</span></span><span style=display:flex><span>     COMMAND: &#34;bash&#34;
</span></span><span style=display:flex><span>        TASK: ffff888102323780  [THREAD_INFO: ffff888102323780]
</span></span><span style=display:flex><span>         CPU: 1
</span></span><span style=display:flex><span>       STATE: TASK_RUNNING (PANIC)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>crash&gt; bt
</span></span><span style=display:flex><span>PID: 4194     TASK: ffff888102323780  CPU: 1    COMMAND: &#34;bash&#34;
</span></span><span style=display:flex><span> #0 [ffffc9000166f968] machine_kexec at ffffffffb0728db3
</span></span><span style=display:flex><span> #1 [ffffc9000166fa58] __crash_kexec at ffffffffb0a417a6
</span></span><span style=display:flex><span> #2 [ffffc9000166fbb8] panic at ffffffffb077eedd
</span></span><span style=display:flex><span> #3 [ffffc9000166fca0] sysrq_handle_crash at ffffffffb1e3228c
</span></span><span style=display:flex><span> #4 [ffffc9000166fcb0] __handle_sysrq at ffffffffb1e334e0
</span></span><span style=display:flex><span> #5 [ffffc9000166fcf8] write_sysrq_trigger at ffffffffb1e34ea4
</span></span><span style=display:flex><span> #6 [ffffc9000166fd18] proc_reg_write at ffffffffb122c99c
</span></span><span style=display:flex><span> #7 [ffffc9000166fd58] vfs_write at ffffffffb10324d4
</span></span><span style=display:flex><span> #8 [ffffc9000166fda8] vfs_fstatat at ffffffffb104cac2
</span></span><span style=display:flex><span> #9 [ffffc9000166fde0] __do_sys_newfstatat at ffffffffb104d252
</span></span><span style=display:flex><span>#10 [ffffc9000166ff38] do_syscall_64 at ffffffffb5aab7c9
</span></span><span style=display:flex><span>#11 [ffffc9000166ff50] entry_SYSCALL_64_after_hwframe at ffffffffb5c0008b
</span></span><span style=display:flex><span>    RIP: 00007fb4c359cb00  RSP: 00007fff42199c08  RFLAGS: 00000202
</span></span><span style=display:flex><span>    RAX: ffffffffffffffda  RBX: 0000000000000002  RCX: 00007fb4c359cb00
</span></span><span style=display:flex><span>    RDX: 0000000000000002  RSI: 00005645a39eeaa0  RDI: 0000000000000001
</span></span><span style=display:flex><span>    RBP: 00005645a39eeaa0   R8: 0000000000000400   R9: 0000000000000410
</span></span><span style=display:flex><span>    R10: 0000000000000000  R11: 0000000000000202  R12: 0000000000000002
</span></span><span style=display:flex><span>    R13: 00007fb4c3679780  R14: 0000000000000002  R15: 00007fb4c3674d00
</span></span><span style=display:flex><span>    ORIG_RAX: 0000000000000001  CS: 0033  SS: 002b
</span></span><span style=display:flex><span>crash&gt; info threads
</span></span><span style=display:flex><span>  Id   Target Id         Frame
</span></span><span style=display:flex><span>* 1    CPU 0             &lt;unavailable&gt; in ?? ()
</span></span><span style=display:flex><span>  2    CPU 1             &lt;unavailable&gt; in ?? ()
</span></span><span style=display:flex><span>crash&gt; panic
</span></span><span style=display:flex><span>panic = $1 =
</span></span><span style=display:flex><span> {void (const char *, ...)} 0xffffffffb077e9b0 &lt;panic&gt;
</span></span><span style=display:flex><span>crash&gt; ps
</span></span><span style=display:flex><span>      PID    PPID  CPU       TASK        ST  %MEM      VSZ      RSS  COMM
</span></span><span style=display:flex><span>&gt;       0       0   0  ffffffffb722b800  RU   0.0        0        0  [swapper/0]
</span></span><span style=display:flex><span>        0       0   1  ffff888102e61bc0  RU   0.0        0        0  [swapper/1]
</span></span><span style=display:flex><span>&gt;    4194      -1   1  ffff888102323780  RU   0.0     4772     3924  bash
</span></span></code></pre></div><p>Note that you should have DEBUG_INFO enabled on the system kernel that crashed!</p><h2 id=general-tips>General tips</h2><p>I use this as my <strong>/root/.bash_profile</strong> inside the VM:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#928374;font-style:italic># fix the row/col height of the terminal</span>
</span></span><span style=display:flex><span>stty rows <span style=color:#8f3f71>71</span> cols <span style=color:#8f3f71>113</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># auto build whatever rep.c copied into /root/ using `rq -f`</span>
</span></span><span style=display:flex><span><span style=color:#af3a03>[</span> -f ~/rep.c <span style=color:#af3a03>]</span> <span style=color:#af3a03>&amp;&amp;</span> gcc ~/rep.c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># make your life easier with some aliases</span>
</span></span><span style=display:flex><span><span style=color:#b57614>alias</span> a<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;./a.out&#34;</span>
</span></span><span style=display:flex><span><span style=color:#b57614>alias</span> s<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;./syz-execprog syz&#34;</span>
</span></span><span style=display:flex><span><span style=color:#b57614>alias</span> kex<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;kexec -p crashkernel --append=&#39;console=ttyS0 root=/dev/sda&#39;&#34;</span>
</span></span></code></pre></div><p>Also this <strong>~/.ssh/config</strong> in my host system to quickly <strong>ssh</strong> or <strong>scp</strong> into the VM:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Host syz
</span></span><span style=display:flex><span>	Hostname localhost
</span></span><span style=display:flex><span>	User root
</span></span><span style=display:flex><span>	NoHostAuthenticationForLocalhost yes
</span></span><span style=display:flex><span>	IdentityFile ~/images/syzkaller.id_rsa
</span></span><span style=display:flex><span>	Port 10022
</span></span></code></pre></div><p>In my host <strong>~/.bashrc</strong>, I use these:</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>LINUX_DIR<span style=color:#af3a03>=</span>~/linux
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># function to get maintainer for a patch from anywhere</span>
</span></span><span style=display:flex><span>get_maintainer<span style=color:#af3a03>()</span> <span style=color:#af3a03>{</span>
</span></span><span style=display:flex><span>	<span style=color:#af3a03>if</span> <span style=color:#af3a03>[</span> -z <span style=color:#79740e>&#34;</span>$1<span style=color:#79740e>&#34;</span> <span style=color:#af3a03>]</span>; <span style=color:#af3a03>then</span>
</span></span><span style=display:flex><span>		<span style=color:#b57614>echo</span> <span style=color:#79740e>&#34;usage: get_maintainer &lt;patch&gt; &lt;opts&gt;&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#af3a03>return</span>
</span></span><span style=display:flex><span>	<span style=color:#af3a03>fi</span>
</span></span><span style=display:flex><span>	patch<span style=color:#af3a03>=</span><span style=color:#af3a03>$(</span>realpath $1<span style=color:#af3a03>)</span>
</span></span><span style=display:flex><span>	<span style=color:#b57614>shift</span> <span style=color:#8f3f71>1</span>
</span></span><span style=display:flex><span>	<span style=color:#af3a03>if</span> <span style=color:#af3a03>[[</span> -f scripts/get_maintainer.pl <span style=color:#af3a03>]]</span>; <span style=color:#af3a03>then</span>
</span></span><span style=display:flex><span>		scripts/get_maintainer.pl <span style=color:#79740e>&#34;</span>$patch<span style=color:#79740e>&#34;</span> $*
</span></span><span style=display:flex><span>	<span style=color:#af3a03>else</span>
</span></span><span style=display:flex><span>		<span style=color:#b57614>pushd</span> $LINUX_DIR/linus &gt; /dev/null  <span style=color:#928374;font-style:italic># assumes a &#39;linus&#39; worktree there</span>
</span></span><span style=display:flex><span>		scripts/get_maintainer.pl <span style=color:#79740e>&#34;</span>$patch<span style=color:#79740e>&#34;</span> $*
</span></span><span style=display:flex><span>		<span style=color:#b57614>popd</span> &gt; /dev/null
</span></span><span style=display:flex><span>	<span style=color:#af3a03>fi</span>
</span></span><span style=display:flex><span><span style=color:#af3a03>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># enables the use of `cd bugs` from anywhere</span>
</span></span><span style=display:flex><span><span style=color:#b57614>shopt</span> -s cdable_vars
</span></span><span style=display:flex><span>bugs<span style=color:#af3a03>=</span>~/syzkaller-bugs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># a few useful aliases</span>
</span></span><span style=display:flex><span><span style=color:#b57614>alias</span> cdL<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;cd </span>$LINUX_DIR<span style=color:#79740e>/linux/linux.git&#34;</span>
</span></span><span style=display:flex><span><span style=color:#b57614>alias</span> cdl<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;cd </span>$LINUX_DIR<span style=color:#79740e>/linux&#34;</span>
</span></span><span style=display:flex><span><span style=color:#b57614>alias</span> checkpatch<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;</span>$LINUX_DIR<span style=color:#79740e>/linus/scripts/checkpatch.pl&#34;</span>
</span></span><span style=display:flex><span><span style=color:#b57614>alias</span> db<span style=color:#af3a03>=</span><span style=color:#79740e>&#34;gdb -tui -ex &#39;target remote :1234&#39; -d linux&#34;</span>
</span></span><span style=display:flex><span><span style=color:#b57614>alias</span> make<span style=color:#af3a03>=</span><span style=color:#79740e>&#39;make -j$(nproc)&#39;</span>
</span></span></code></pre></div><p>I hope I provided some inspiration to improve your workflow if you are a kernel hacker
wannabe like myself. If you have any question, comment, critic, suggestion or if you
spotted an error in here, please don&rsquo;t hesitate in reaching out to me at
<a href=mailto:ricardo@marliere.net>ricardo@marliere.net</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>As far as I can tell, <strong>kdump-tools</strong> is packaged with the clear use case of
dumping a running Debian kernel and depends on the distro <strong>/boot/*</strong> files&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></main><footer>&copy; <a href=https://github.com/rbmarliere/marliere.net>Copyleft</a>
2024 Ricardo B. Marliere
<a href=/index.xml title="Ricardo's Blog"><i class="fa-solid fa-rss"></i></a></footer></div></body></html>